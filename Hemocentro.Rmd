---
title: "Hemocentro"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
  word_document: default
---

Análise da base de dados do hemocentro de Porto Alegre
<br />
Fontes:
<br />
https://www.fee.rs.gov.br/indicadores/populacao/estimativas-populacionais/


#### Carregando bibliotecas
```{r}
library(ggplot2)
library(tidyr)
library(gridExtra)
library(readr)
library(stringr)
library(reshape2)
library(stringi)

# SE ESTIVER USANDO MAC, Setando Encoding
Sys.setlocale("LC_ALL", "pt_BR.UTF-8")
```

### Carregando dados
<br />
#### Listando uma amostra dos dados para ver se está tudo ok.
```{r}
doacoes <- read.csv2(file = 'doacoes.csv', stringsAsFactors=FALSE, fileEncoding="cp857", sep = ",")
head(doacoes)
```
<br />
Perfeito, tive que rastrear o encoding correto para o arquivo, o cp857 foi o único que conseguiu carregar os dados com acentuação correta.
<br />
Quantidade de registros
```{r}
nrow(doacoes)
```
<br />
Parece que alguns valores na tabela de doações estão com acentuação e outros não, outros estão com valores totalmente fora do contexto, como esperado pela leitura externa, então vamos ter que 
trabalhar estes dados para termos consistência ao gerar gráficos e agrupamentos.

Primeiro vamos renomear estas colunas, os nomes atuais não deixao o código refletir o real sentido do que está sendo feito.
```{r}
colnames(doacoes)[colnames(doacoes)=="c_residencial"] <- "cidade"
colnames(doacoes)[colnames(doacoes)=="b_residencial"] <- "bairro"

#Seto o nome das colunas para maiúsculo, acho melhor de trabalhar e visualizar no codigo.
colnames(doacoes) <- toupper(colnames(doacoes))
```

####  Trabalhando a questão da acentuação.
```{r}
#Removendo acentuação.
doacoes$CIDADE <- stri_trans_general(doacoes$CIDADE,"Latin-ASCII")


#Convertemos colunas categóricas para factor para que o agrupamento se dê de forma mais categórica.
doacoes$CIDADE <- as.factor(doacoes$CIDADE)
doacoes$CIDADE <- toupper(doacoes$CIDADE)
doacoes$ABO_DOADOR <- as.factor(doacoes$ABO_DOADOR)
```
<br />
#### Vamos começar analisando os dados que temos em mãos, antes de tentar qualquer associaão com o outro dataframe.

## Doações
<br />
### Doações por cidade
#### Sumário dos dados
```{r}
summary(doacoes)
summary(doacoes$ABO_DOADOR)
```
<br />
O sumário aponta um tipo sanguineo diferente dos normais, vamos listar para ver quais valores temos.
<br />
Ok, temos 102 valores nulos, 132 valores Zero, 7 valores como 'Brasil', 5 valores 'O' com espaçamento a direita, 4 valores N e 12 vaores 'I'.
Temos que decidir ou não remover estes dados. Como temos vários registros e no momento não queremos analisar o
tipo sanguineo e sim focar nas doações, vamos deixar esses valores, pois removê-los nos traria um impacto que não necessitamos no momento.
<br />
Vamos primeiro ajustar os valores 'O' com espaçamento para o valor correto.
```{r}
doacoes$ABO_DOADOR[doacoes$ABO_DOADOR == "O "] <- "O"
summary(doacoes$ABO_DOADOR)
```

## Analisando o perfil do doador: Cidades e Proporção de doações

Vamos agora analisar os valores de doados por município, analisar não somente a quantidade doações, mas a proporção de doações baseando-se na proporção. 
Primeiro temos que conseguir o valor populacional. Não podemos simplesmente pegar o valor populacional, mas sim o valor populacional da faixa etária aceitável para doações.
Navegando até o site: https://www.fee.rs.gov.br/wp-content/uploads/2014/03/20170831populacao-municipio-sexo-fx-etaria.xls conseguimos os valores referênte ao estado do RS, o estado que nos interessa, visto que o hospital tem como foco os hospitais do estado, por mais que ainda forneça para outros estados o foco é estadual. 

O dataset fornecido pelo link nos traz os dados agrupados por faixa etária. Agrupei, via excel mesmo, os valores referênte a faixa etária de 14 a 69 anos.

Vamos começar a analisar a questão das cidades.

#### Valores de cidades - Dataset Doações
```{r}
cidades <- doacoes %>%
  subset(!is.null(CIDADE) & CIDADE != 'NULL')

cidades <- table(cidades$CIDADE)
head(cidades)
```
<br />
#### Quantidade de cidades
```{r}
length(cidades)
```
<br />
Agora vamos pegar esse agrupamento de Cidade/Doacoes que está em formato Table e transformar para um Dataframe, para conseguir melhor trabalhar com os dados.
```{r}
cidades <- as.data.frame(cidades)
colnames(cidades) <- c("Cidade", "Doacoes")
head(cidades)
```
<br />
#### Ordenando as 10 principais cidades com mais doadores
```{r}
order.donnations <- with(cidades, order(-Doacoes))
first_ten <- head(cidades[order.donnations,],  10)
first_ten
```

<br />
Ok, temos bastante registros para plotar e não teríamos como exibir toda essa quantidade de valores únicos em um gráfico, não de forma que ficasse de fácil visualização.
Vamos começar listando as 10 cidades com maior quantidade de doadores.
```{r}
first_ten %>% 
  ggplot(mapping = aes(x = Cidade, y = Doacoes))+
  geom_col() +
  ylab("Quantidade de doações")+
  theme(axis.text=element_text(size=8),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))

```
<br />
Bom, as 10 primeira cidades, especiamente a primeira, estrapolam nossa chance de printar um gráfico de forma que fique 
apresentável. 
<br />

#### Comparando o percentual de doações baseando-se na quantidade de habitantes.
Vamos começar carregando o indicador populacional por cidades do estado do RS.
<br />
```{r}
pop_cidades <- read.csv2(file = '20170831populacao-municipio-sexo-fx-etaria2.csv', sep = ",")

#Vamos validar a classe das colunas
lapply(pop_cidades, class)

head(pop_cidades)
```
<br />
Bom, os nomes das cidades estão em formato normal quando que os do nosso dataset de doações estão todos em caixa alta.
Vamos ter que trabalhar os dos dois, pois parece que alguns dos registros do dataset de doações não estão em caixa alta.
<br />
```{r}
pop_cidades$MUNICÍPIO <- str_to_upper(pop_cidades$MUNICÍPIO)
pop_cidades$MUNICÍPIO <- stri_trans_general(pop_cidades$MUNICÍPIO,"Latin-ASCII")

head(pop_cidades)
```
<br />
Quase pronto, antes precisamos ter as tabelas com o mesmo nome para a coluna Municipio, hoje no dataset de doações
estão com nome de 'CIDADE' e no de pop_cidades está como 'MUNICIPIO'.
Para padronizar, vamos renomear a tabela pop_cidade, até pelo fato do dataset estar com 'cidade' no nome.
<br />
```{r}
colnames(pop_cidades)[1]  <- "CODIGO"
colnames(pop_cidades)[2]  <- "CIDADE"
colnames(pop_cidades)[4]  <- "TOTAL_H"
colnames(pop_cidades)[5]  <- "TOTAL_M"

#Listando somente as colunas que nos interessam
pop_cidades <- pop_cidades[,c("CODIGO","CIDADE","TOTAL", "TOTAL_H", "TOTAL_M")]

head(pop_cidades)
```
<br />
Perfeito, agora podemos unir a tabela de municípios com a tabela de doações.
<br />
```{r}
doacoes <- doacoes %>%
  subset(!is.null(CIDADE) & CIDADE != 'NULL')

doacoes <- doacoes %>%
  dplyr::left_join(pop_cidades, by = "CIDADE") 

head(doacoes)
```
<br />
Agora vamos calcular a proporção de doações em relação a população da cidade.
Vamos começar com uma análise mais ampla, vamos agrupar por cidade e depois por cidade e sexo.
<br />
#### Agrupamento por CIDADE
```{r}
doacoes$CIDADE <- as.factor(doacoes$CIDADE)

group_cidade <- dplyr::group_by(doacoes, CIDADE, TOTAL, TOTAL_H, TOTAL_M)%>%
  dplyr::summarise(DOACOES=n()) %>%
  dplyr::arrange(-DOACOES)


group_cidade$PROPORCAO <- (group_cidade$DOACOES/group_cidade$TOTAL)

group_cidade <- group_cidade %>% 
  dplyr::arrange(-PROPORCAO)

```
<br />
#### As cidades com maior proporção de doações por habitantes
```{r}
group_cidade %>% 
  head(n = 10) %>%
  ggplot(mapping = aes(x = CIDADE, y = PROPORCAO))+
  geom_bar(stat = "identity")+
  ylab("Proporção")+
  coord_flip()+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))
```
<br />
#### Agrupamento por CIDADE e SEXO
Para agrupamento por cidade, vamos fazer diferente, vamos dividir nosso dataset em dois, pois temos os casos de mulheres e homens, provavelmente
a proporção de doação será diferente em uma mesma cidade para homens e para mulheres.
```{r}

# Começamos agrupando o nosso dataset por sexo.
group_cidade_sexo <- dplyr::group_by(doacoes, CIDADE, TOTAL, TOTAL_H, TOTAL_M, SEXO)%>%
  dplyr::summarise(DOACOES=n())

group_cidade_sexo$PROPORCAO <- group_cidade_sexo$DOACOES/group_cidade_sexo$TOTAL

#Ok, agora precisamos separar mulheres e homens já aproveitando para remover dados incompletos.
group_cidade_homens <- subset(group_cidade_sexo, SEXO == 'M')
group_cidade_homens <- group_cidade_homens[complete.cases(group_cidade_homens[,1:7]),]

group_cidade_mulheres <- subset(group_cidade_sexo, SEXO == 'F')
group_cidade_mulheres <- group_cidade_mulheres[complete.cases(group_cidade_mulheres[,1:7]),]

#Agora vamos filtrar somente as 10 cidades com maiores proporções de doação para cada sexo.
group_cidade_homens <- group_cidade_homens %>%
  dplyr::arrange(-PROPORCAO) %>%
  head(n=10)

group_cidade_mulheres <- group_cidade_mulheres %>%
  dplyr::arrange(-PROPORCAO) %>%
  head(n=10)

#Pronto, agora vamos agrupar novamente os dados para então plotarmos esses valores.
group_cidade_sexo <- dplyr::union(group_cidade_homens, group_cidade_mulheres)

head(group_cidade_sexo)
```
<br />
#### As cidades com maior proporção de doações por habitantes separados por sexo
```{r}
plot_m <- group_cidade_sexo %>%
  subset(SEXO == 'M') %>%
  ggplot(mapping = aes(x = CIDADE, y = PROPORCAO))+
  geom_bar(stat = "identity")+
  ylab("Masculino")+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))

plot_f <- group_cidade_sexo %>%
  subset(SEXO == 'F') %>%
  ggplot(mapping = aes(x = CIDADE, y = PROPORCAO))+
  geom_bar(stat = "identity")+
  ylab("Feminino")+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))


grid.arrange(plot_m, plot_f, ncol = 2)
```
<br />
#### Exibindo proporção de doações para cada gênero em todas as 10 cidades com maior proporção para cada gênero
```{r}
group_cidade_sexo %>%
  subset(CIDADE %in% group_cidade_sexo$CIDADE) %>%
  ggplot(mapping = aes(x = CIDADE, y = PROPORCAO, color= SEXO, fill=SEXO))+
  geom_bar(stat = "identity")+
  ylab("Proporção")+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))  
```
<br />
### Tipos de doações
Vamos analisar os tipos de doações e a quantidade de cada tipo. Vamos começar focando nas cidades onde as mulheres tiveram 100% das doações e onde os homens foram responsáveis por 100% delas.
<br />
#### Tipo de doações onde homens tiveram 100% de doações
```{r}
nomes <- c("ESTEIO", "MORRO REUTER", "FELIZ", "TRES FORQUILHAS")

doacoes %>%
  dplyr::filter(CIDADE %in% nomes) %>%
  ggplot(mapping = aes(x = TIPO_DOACAO))+
  geom_bar()+
  labs(title="Cidades com doacoes 100% de homens")+
  ylab("Quantidade")+
  xlab("Tipo")+
  coord_flip()+
  theme(axis.text=element_text(size=8),
        plot.title = element_text(color="red", size=12, face="bold.italic"),
        axis.title=element_text(size=14,face="bold")) 
```
<br />
#### Tipo de doações onde mulheres tiveram 100% de doações
```{r}
nomes <- c("BOM PRINCIPIO", "BOM RETIRO DO SUL", "SANTA MARIA DO HERVAL", "MINAS DO LEAO")

doacoes %>%
  dplyr::filter(CIDADE %in% nomes) %>%
  ggplot(mapping = aes(x = TIPO_DOACAO))+
  geom_bar()+
  labs(title="Cidades com doacoes 100% de mulheres")+
  ylab("Quantidade")+
  xlab("Tipo")+
  coord_flip()+
  theme(axis.text=element_text(size=8),
        plot.title = element_text(color="red", size=12, face="bold.italic"),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold")) 
```
<br />
Nesses casos onde as mulheres tiveram doações 100% dos casos, temos o dobro de doações de onde tivemos homens com 100% das doações.
Vamos analisar todo o dataset por tipo de doação, separando por sexo.
<br />
#### Quantidade de doações x Tipo x Sexo
```{r}
doacoes %>%
  ggplot(mapping = aes(x = TIPO_DOACAO))+
  geom_bar()+
  labs(title="Quantidade de doações x Tipo x Sexo")+
  ylab("Quantidade")+
  xlab("Tipo")+
  coord_flip()+
  theme(axis.text=element_text(size=5),
        plot.title = element_text(color="red", size=12, face="bold.italic"),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))+
  facet_wrap(~ SEXO, ncol = 1)
```
<br />
Em ambos os sexos temos mais doações do tipo 'Sangue total reposição' e 'Sangue total espontânea' com o tipo 'Plaquetaferese espontânea' como o terceiro mais citado.
<br />
### Doações e Idade
#### Criando função para calcular a idade dos doadores
Nosso dataset não possuí a idade dos doadores já calculad, mas possuí a data de nascimento.
Vamos então criar uma função para calcular a idade dos doadores.
```{r}
calc_idade <- function(data_str) {
  data_nasc <- as.Date(as.character(data_str), format="%d/%m/%Y")
  years <- as.numeric(difftime(Sys.Date(), data_nasc, unit="weeks"))/52.25
  return(as.numeric(round(years)))
}
```
<br />
#### Aplicando função no DF
```{r}
doacoes$IDADE <- sapply(doacoes$DATA_NASC, calc_idade)
summary(doacoes$IDADE)
```
<br />
#### Distribuição de doações por idade e sexo
Vamos analisar a distribuição de idade dos doadores, novamente agrupado por sexo.
```{r}
doacoes %>%
  dplyr::group_by(IDADE, SEXO)%>%
  dplyr::summarise(DOACOES=n()) %>%
  ggplot(mapping = aes(x = IDADE, y = DOACOES, color=SEXO))+
  geom_line()+
  labs(title="Quantidade de doacoes x Idade x Sexo")+
  ylab("Quantidade")+
  xlab("Idade")+
  theme(axis.text=element_text(size=5),
        plot.title = element_text(color="red", size=12, face="bold.italic"),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))
```
<br />
#### Distribuição de idade entre os doados agrupados por sexo
```{r}
doacoes %>%
  ggplot(mapping = aes(x = IDADE))+
  geom_histogram()+
  labs(title="Quantidade de doações x Tipo x Sexo")+
  ylab("Quantidade")+
  xlab("Idade")+
  theme(axis.text=element_text(size=5),
        plot.title = element_text(color="red", size=12, face="bold.italic"),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))+
  facet_wrap(~ SEXO, ncol = 1)
```
<br />
#### Analisando as doações da cidade de Porto Alegre
```{r}
poa_df <- doacoes %>%
  subset(doacoes$CIDADE == 'PORTO ALEGRE' & doacoes$BAIRRO != 'NULL' & !is.null(doacoes$BAIRRO))

poa_df$BAIRRO <- as.factor(poa_df$BAIRRO)
print('Sumário por bairros.')
summary(poa_df$BAIRRO)
```
Ok, temos vários resultados, não seria nada interessante colocar todos esses valores em um gráfico.
Vamos limitar somente nos bairros com mais de 100 doadores.
<br />
#### Filtrando bairros
```{r}
poa_bairros_df <- poa_df[ poa_df$BAIRRO %in%  names(table(poa_df$BAIRRO))[table(poa_df$BAIRRO) > 2197] , ]

poa_bairros_df %>% 
  ggplot(mapping = aes(x = BAIRRO))+
  geom_bar() +
  ylab("Número de Doadores")+
  labs(title="Quantidade Doadores por Bairro")+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))
```
<br />
#### Filtrando bairros e agrupando por sexo
```{r}
poa_bairros_df %>% 
  ggplot(mapping = aes(x = BAIRRO, color=SEXO, fill=SEXO))+
  geom_bar() +
  ylab("Número de Doadores")+
  labs(title="Quantidade Doadores por Bairro agrupado por Sexo")+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))
```
<br />
#### Distribuição dos dados por idade
```{r}
doacoes %>% 
  ggplot(mapping = aes(x = IDADE))+
  geom_histogram(binwidth = 1)+
  ylab("Quantidade")+
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=14,face="bold"))
```
<br />
#### Distribuição dos dados por idade e sexo
```{r}
doacoes %>%
  ggplot(mapping = aes(SEXO, IDADE, color=SEXO))+
  geom_boxplot()
```
<br />
#### Distribuição dos dados por idade e sexo
```{r}
doacoes %>% 
  ggplot(mapping = aes(x = IDADE))+
  geom_histogram(binwidth = 2)+
  ylab("Quantidade")+
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=14,face="bold"))+
  facet_wrap( ~ SEXO, ncol = 2)
```
<br />
#### Distribuição dos dados por idade e sexo na cidade de Porto Alegre
```{r}
doacoes %>% 
  subset(CIDADE == 'PORTO ALEGRE') %>%
  ggplot(mapping = aes(x = IDADE))+
  geom_histogram(binwidth = 2)+
  ylab("Quantidade")+
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=14,face="bold"))+
  facet_wrap( ~ SEXO, ncol = 2)
```
<br />
#### Distribuição dos dados por idade e sexo nas principais cidades exceto Porto Alegre
```{r}
doacoes[ doacoes$CIDADE %in%  names(table(doacoes$CIDADE))[table(doacoes$CIDADE) > 2197] , ] %>% 
  subset(CIDADE != 'PORTO ALEGRE') %>%
  ggplot(mapping = aes(x = IDADE))+
  geom_histogram(binwidth = 1)+
  ylab("Quantidade")+
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=14,face="bold"))+
  facet_wrap( ~CIDADE, ncol = 2)
```

#### Analizando o cenário de Tupandi - Tipo Sanguíneo
```{r}
tipo_sangue <- subset(doacoes, CIDADE == 'SERTAO SANTANA') %>%
  dplyr::group_by(ABO_DOADOR, SEXO)%>%
  dplyr::summarise(QUANTIDADE=n())
 
tipo_sangue%>%
 ggplot(mapping = aes(x = ABO_DOADOR, y = QUANTIDADE))+
 geom_bar(stat = "identity")+
  geom_text(aes(label=QUANTIDADE), vjust=-0.2, color="blue") +
 labs(title="Quantidade de doação por tipo sanguíneo e sexo")+
 ylab("Quantidade")+
 xlab("Tipo Sanguíneo")+
 theme(plot.title = element_text(color="red", size=12, face="bold.italic"),
       axis.text.x = element_text(angle = 90, hjust = 1),
       axis.title=element_text(size=14,face="bold"))+
  facet_wrap(~SEXO, ncol=2)
```
<br /> 
Com os resultados de Tupandi tinham apresentado um cenário bem peculiar, devido ao fato de ser uma cidade pequena e o número de doação tanto de homens como de mulheres serem iguais, poderíamos constatar que foi uma mobilização social em prol de alguém da cidade, mas não parece o caso. Ainda pode ser o caso de ser uma doação resultante de uma mobilização social de algum grupo da cidade, mas podemos ter certeza que não foi uma mobilização em prol de alguém específico.
<br />
Para ter certeza da última constatação, vamos listar o motivo da doação efetuada pela população de Tupandi.

#### Tipo de Doação em Tupandi
```{r}
doacoes %>%  
 subset(CIDADE == 'SERTAO SANTANA') %>%
 dplyr::group_by(TIPO_DOACAO, SEXO)%>%
 dplyr::summarise(QUANTIDADE=n())%>%
 ggplot(mapping = aes(x = TIPO_DOACAO, y = QUANTIDADE))+
  geom_bar(stat = "identity")+
  geom_text(aes(label=QUANTIDADE), vjust=0, color="red") +
  labs(title="Quantidade por Tipo de doação e sexo")+
  ylab("Quantidade")+
  xlab("Tipo Doação")+
  theme(plot.title = element_text(color="red", size=12, face="bold.italic"),
       axis.text.x = element_text(angle = 90, hjust = 1),
       axis.title=element_text(size=14,face="bold"))+
  facet_wrap(~SEXO, ncol=2)
```

#### Proporção do Tipo de Doação em Tupandi
```{r}
maior_prop_doacoes <- subset(doacoes, CIDADE == 'SERTAO SANTANA')
 
```


Agora temos um case interessante, tanto para homens como para mulheres o tipo de doação em mais de x% dos casos é do tipo de Reposição, ou seja, tinham o objetivo de doar para alguém específico.
Vamos analisar o tipo de doação e o tipo sanguíneo.

#### Tipo de Doação em Tupandi por Tipo sanguíneo
```{r}
doacoes %>%  
 subset(CIDADE == 'SERTAO SANTANA' & ABO_DOADOR != 'NULL') %>%
 dplyr::group_by(TIPO_DOACAO, ABO_DOADOR)%>%
 dplyr::summarise(QUANTIDADE=n())%>%
 ggplot(mapping = aes(x = TIPO_DOACAO, y = QUANTIDADE))+
  geom_bar(stat = "identity")+
  geom_text(aes(label=QUANTIDADE), vjust=0, color="red") +
  labs(title="Quantidade por Tipo de doação e Tipo Sanguíneo")+
  ylab("Quantidade")+
  xlab("Tipo Doação")+
  theme(plot.title = element_text(color="red", size=12, face="bold.italic"),
       axis.text.x = element_text(angle = 90, hjust = 1),
       axis.title=element_text(size=14,face="bold"))+
  facet_wrap(~TIPO_SANGUE, ncol=2)
```


