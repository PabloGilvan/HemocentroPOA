---
title: "Hemocentro"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
  word_document: default
---

Análise da base de dados do hemocentro de Porto Alegre
<br />
<br />
Fontes:
<br />
https://www.fee.rs.gov.br/indicadores/populacao/estimativas-populacionais/


#### Carregando bibliotecas
```{r}
library(tidyverse)
library(gridExtra)
library(readr)
library(stringr)
library(reshape2)
library(stringi)

# SE ESTIVER USANDO MAC, Setando Encoding
Sys.setlocale("LC_ALL", "pt_BR.UTF-8")
```

### Carregando dados
<br />
#### Listando uma amostra dos dados para ver se está tudo ok.
```{r}
doacoes <- read.csv2(file = 'doacao-Table 1.csv')
head(doacoes)
```
<br />
Quantidade de registros
```{r}
nrow(doacoes)
```
<br />
A tabela parece ter uma coluna ID fora do contexto. Vamos removela. 
```{r}
doacoes <- subset(doacoes, select = -c(ID) )
```
<br />
<br />
<br />
<br />
#### Vamos começar analisando os dados que temos em mãos, antes de tentar qualquer associaão com o outro dataframe.

## Doações

<br />
<br />

### Doações por cidade
#### Sumário dos dados
```{r}
summary(doacoes)
```
<br />
O sumário aponta um tipo sanguineo diferente dos normais, vamos listar para ver quais valores temos.
<br />
```{r}
summary(doacoes$TIPO_SANGUE)
```
<br />
<br />
Ok, temos 2572 valores nulos, 14 valores Zero e dois vaores 'I'
Temos que decidir ou não remover estes dados. Como temos vários registros e no momento não queremos analisar o
tipo sanguineo e sim focar nas doações, vamos deixar esses valores, pois removê-los nos traria um impacto que não necessitamos no momento.
<br />
<br />
#### Valores de cidades
```{r}
cidades <- table(doacoes$CIDADE)
head(cidades)
```
<br />
#### Quantidade de cidades
```{r}
length(cidades)
```
<br />
Agora vamos pegar esse agrupamento de Cidade/Doacoes que está em formato Table e transformar para um Dataframe, para conseguir melhor trabalhar com os dados.
```{r}
cidades <- as.data.frame(cidades)
colnames(cidades) <- c("Cidade", "Doacoes")
head(cidades)
```
<br />
<br />
#### Ordenando as 10 principais cidades com mais doadores
```{r}
order.donnations <- with(cidades, order(-Doacoes))
first_ten <- head(cidades[order.donnations,],  10)
first_ten
```
<br />
<br />
Ok, temos bastante registros para plotar e não teríamos como exibir toda essa quantidade de valores únicos em um gráfico, não de forma que ficasse de fácil visualização.
Vamos começar listando as 10 cidades com maior quantidade de doadores.
```{r}
first_ten %>% 
  ggplot(mapping = aes(x = Cidade, y = Doacoes))+
  geom_col() +
  ylab("Quantidade de doações")+
  theme(axis.text=element_text(size=8),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))

```
<br />
<br />
Bom, as 10 primeira cidades, especiamente a primeira, estrapolam nossa chance de printar um gráfico de forma que fique 
apresentável. 
<br />
<br />
#### Comparando o percentual de doações baseando-se na quantidade de habitantes.
Vamos começar carregando o indicador populacional por cidades do estado do RS.
<br />
```{r}
pop_cidades <- read.csv2(file = '20170831populacao-municipio-sexo-fx-2016.csv', sep = ";")
head(pop_cidades)
```
<br />
<br />
Bom, os nomes das cidades estão em formato normal quando que os do nosso dataset de doações estão todos em caixa alta.
Vamos ter que trabalhar os dos dois, pois parece que alguns dos registros do dataset de doações não estão em caixa alta.
<br />
```{r}
pop_cidades$MUNICIPIO <- str_to_upper(pop_cidades$MUNICIPIO)
doacoes$CIDADE <- str_to_upper(doacoes$CIDADE)

head(pop_cidades)
```
<br />
Quase pronto, antes precisamos ter as tabelas com o mesmo nome para a coluna Municipio, hoje no dataset de doações
estão com nome de 'CIDADE' e no de pop_cidades está como 'MUNICIPIO'.
Para padronizar, vamos renomear a tabela pop_cidade, até pelo fato do dataset estar com 'cidade' no nome.
<br />
```{r}
colnames(pop_cidades)[2]  <- "CIDADE"
head(pop_cidades)
```
<br />
Também nos deparamos com outra situação, parece que alguns valores na tabela de doações estão com acentuação e outros não.
```{r}
aux <- doacoes %>%
  filter(str_detect(CIDADE,"SÃO"))

print(aux$CIDADE[1:2])

aux <- doacoes %>%
  filter(str_detect(CIDADE,"SAO"))

print(aux$CIDADE[1:2])

#Removendo acentuação.
doacoes$CIDADE <- stri_trans_general(doacoes$CIDADE,"Latin-ASCII")

# VALORES COM ACENTUAÇÃO
doacoes %>%
  filter(str_detect(CIDADE,"GRAVATAÍ")) %>%
  head() %>%
  print()

# VALORES SEM ACENTUAÇÃO
doacoes %>%
  filter(str_detect(CIDADE,"GRAVATAI")) %>%
  head() %>%
  print()
  
pop_cidades$CIDADE <- stri_trans_general(pop_cidades$CIDADE,"Latin-ASCII")
```
<br />
Perfeito, agora podemos unir a tabela de municípios com a tabela de doações.
<br />
```{r}
doacoes <- doacoes %>%
  left_join(pop_cidades, by = "CIDADE") 

head(doacoes)
```
<br />
Agora vamos calcular a proporção de doações em relação a população da cidade.
Vamos começar com uma análise mais ampla, vamos agrupar por cidade e depois por cidade e sexo.
<br />
#### Agrupamento por CIDADE
```{r}
doacoes$CIDADE <- factor(doacoes$CIDADE)

group_cidade <- group_by(doacoes, CIDADE, TOTAL, TOTAL_H, TOTAL_M)%>%
  summarise(DOACOES=n()) %>%
  arrange(-DOACOES)

group_cidade$PROPORCAO <- group_cidade$DOACOES/group_cidade$TOTAL

group_cidade <- group_cidade %>% 
  arrange(-PROPORCAO)

```
<br />
<br />
#### As cidades com maior proporção de doações por habitantes
```{r}
group_cidade %>% 
  head(n = 10) %>%
  ggplot(mapping = aes(x = CIDADE, y = PROPORCAO))+
  geom_bar(stat = "identity")+
  ylab("Proporção")+
  coord_flip()+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))
```
<br />
<br />
#### Agrupamento por CIDADE e SEXO
Para agrupamento por cidade, vamos fazer diferente, vamos dividir nosso dataset em dois, pois temos os casos de mulheres e homens, provavelmente
a proporção de doação será diferente em uma mesma cidade para homens e para mulheres.
```{r}

# Começamos agrupando o nosso dataset por sexo.
group_cidade_sexo <- group_by(doacoes, CIDADE, TOTAL, TOTAL_H, TOTAL_M, SEXO)%>%
  summarise(DOACOES=n())

group_cidade_sexo$PROPORCAO <- group_cidade_sexo$DOACOES/group_cidade_sexo$TOTAL

#Ok, agora precisamos separar mulheres e homens já aproveitando para remover dados incompletos.
group_cidade_homens <- subset(group_cidade_sexo, SEXO == 'M')
group_cidade_homens <- group_cidade_homens[complete.cases(group_cidade_homens[,1:7]),]

group_cidade_mulheres <- subset(group_cidade_sexo, SEXO == 'F')
group_cidade_mulheres <- group_cidade_mulheres[complete.cases(group_cidade_mulheres[,1:7]),]

#Agora vamos filtrar somente as 10 cidades com maiores proporções de doação para cada sexo.
group_cidade_homens <- group_cidade_homens %>%
  arrange(-PROPORCAO) %>%
  head(n=10)

group_cidade_mulheres <- group_cidade_mulheres %>%
  arrange(-PROPORCAO) %>%
  head(n=10)

#Pronto, agora vamos agrupar novamente os dados para então plotarmos esses valores.
group_cidade_sexo <- union(group_cidade_homens, group_cidade_mulheres)

head(group_cidade_sexo)
```
<br />
<br />
#### As cidades com maior proporção de doações por habitantes separados por sexo
```{r}

plot_m <- group_cidade_sexo %>%
  subset(SEXO == 'M') %>%
  ggplot(mapping = aes(x = CIDADE, y = PROPORCAO))+
  geom_bar(stat = "identity")+
  ylab("Masculino")+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))

plot_f <- group_cidade_sexo %>%
  subset(SEXO == 'F') %>%
  ggplot(mapping = aes(x = CIDADE, y = PROPORCAO))+
  geom_bar(stat = "identity")+
  ylab("Feminino")+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))


grid.arrange(plot_m, plot_f, ncol = 2)
```
<br />
<br />
#### Exibindo proporção de doações para cada gênero em todas as 10 cidades com maior proporção para cada gênero
```{r}
group_cidade_sexo %>%
  subset(CIDADE %in% group_cidade_sexo$CIDADE) %>%
  ggplot(mapping = aes(x = CIDADE, y = PROPORCAO, color= SEXO, fill=SEXO))+
  geom_bar(stat = "identity")+
  ylab("Proporção")+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))  
```
<br />
<br />
### Tipos de doações
Vamos analisar os tipos de doações e a quantidade de cada tipo. Vamos começar focando nas cidades onde as mulheres tiveram 100% das doações e onde os homens foram responsáveis por 100% delas.
<br />
#### Tipo de doações onde homens tiveram 100% de doações
```{r}
nomes <- c("CAPAO BONITO DO SUL", "MORRO REUTER", "PARAI", "SENTINELA DO SUL")

doacoes %>%
  filter(CIDADE %in% nomes) %>%
  ggplot(mapping = aes(x = TIPO))+
  geom_bar()+
  labs(title="Cidades com doacoes 100% de homens")+
  ylab("Quantidade")+
  xlab("Tipo")+
  coord_flip()+
  theme(axis.text=element_text(size=8),
        plot.title = element_text(color="red", size=12, face="bold.italic"),
        axis.title=element_text(size=14,face="bold")) 
```
<br />
<br />
#### Tipo de doações onde mulheres tiveram 100% de doações
```{r}
nomes <- c("IVOTI", "MARIANA PIMENTEL", "SANTA MARIA DO HERVAL", "SAO PEDRO DA SERRA")

doacoes %>%
  filter(CIDADE %in% nomes) %>%
  ggplot(mapping = aes(x = TIPO))+
  geom_bar()+
  labs(title="Cidades com doacoes 100% de mulheres")+
  ylab("Quantidade")+
  xlab("Tipo")+
  coord_flip()+
  theme(axis.text=element_text(size=8),
        plot.title = element_text(color="red", size=12, face="bold.italic"),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold")) 
```
<br />
<br />
Nesses casos onde as mulheres tiveram doações 100% dos casos, temos o dobro de doações de onde tivemos homens com 100% das doações.
Vamos analisar todo o dataset por tipo de doação, separando por sexo.
<br />
<br />
#### Quantidade de doações x Tipo x Sexo
```{r}
doacoes %>%
  ggplot(mapping = aes(x = TIPO))+
  geom_bar()+
  labs(title="Quantidade de doações x Tipo x Sexo")+
  ylab("Quantidade")+
  xlab("Tipo")+
  coord_flip()+
  theme(axis.text=element_text(size=5),
        plot.title = element_text(color="red", size=12, face="bold.italic"),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))+
  facet_wrap(~ SEXO, ncol = 1)
```
<br />
Em ambos os sexos temos mais doações do tipo 'Sangue total reposição' e 'Sangue total espontânea' com o tipo 'Plaquetaferese espontânea' como o terceiro mais citado.
<br />
<br />
<br />
### Doações e Idade
#### Criando função para calcular a idade dos doadores
Nosso dataset não possuí a idade dos doadores já calculad, mas possuí a data de nascimento.
Vamos então criar uma função para calcular a idade dos doadores.
```{r}
calc_idade <- function(data_str) {
  data_nasc <- as.Date(as.character(data_str), format="%Y-%m-%d %H:%M:%S")
  years <- as.numeric(difftime(Sys.Date(), data_nasc, unit="weeks"))/52.25
  return(as.numeric(round(years)))
}
```
<br />
#### Aplicando função no DF
```{r}
doacoes$IDADE <- sapply(doacoes$NASCIMENTO, calc_idade)
summary(doacoes$IDADE)
```
<br />
<br />
#### Distribuição de doações por idade e sexo
Vamos analisar a distribuição de idade dos doadores, novamente agrupado por sexo.
```{r}
doacoes %>%
  group_by(IDADE, SEXO)%>%
  summarise(DOACOES=n()) %>%
  ggplot(mapping = aes(x = IDADE, y = DOACOES, color=SEXO))+
  geom_line()+
  labs(title="Quantidade de doacoes x Idade x Sexo")+
  ylab("Quantidade")+
  xlab("Idade")+
  theme(axis.text=element_text(size=5),
        plot.title = element_text(color="red", size=12, face="bold.italic"),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))
```
<br />
<br />
#### Distribuição de idade entre os doados agrupados por sexo
```{r}
doacoes %>%
  ggplot(mapping = aes(x = IDADE))+
  geom_histogram()+
  labs(title="Quantidade de doações x Tipo x Sexo")+
  ylab("Quantidade")+
  xlab("Idade")+
  theme(axis.text=element_text(size=5),
        plot.title = element_text(color="red", size=12, face="bold.italic"),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))+
  facet_wrap(~ SEXO, ncol = 1)
```
<br />
<br />
#### Analisando as doações da cidade de Porto Alegre
```{r}
poa_df <- subset(doacoes, doacoes$CIDADE == 'PORTO ALEGRE')

print('Sumário por bairros.')
summary(poa_df$BAIRRO)
```
Ok, temos vários resultados, não seria nada interessante colocar todos esses valores em um gráfico.
Vamos limitar somente nos bairros com mais de 100 doadores.

<br />
<br />
#### Filtrando bairros
```{r}
poa_bairros_df <- poa_df[ poa_df$BAIRRO %in%  names(table(poa_df$BAIRRO))[table(poa_df$BAIRRO) > 100] , ]

poa_bairros_df %>% 
  ggplot(mapping = aes(x = BAIRRO))+
  geom_bar() +
  ylab("Número de Doadores")+
  labs(title="Quantidade Doadores por Bairro")+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))
```
<br />
<br />
#### Filtrando bairros e agrupando por sexo
```{r}
poa_bairros_df %>% 
  ggplot(mapping = aes(x = BAIRRO, color=SEXO, fill=SEXO))+
  geom_bar() +
  ylab("Número de Doadores")+
  labs(title="Quantidade Doadores por Bairro agrupado por Sexo")+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))
```
<br />
<br />
#### Distribuição dos dados por idade
```{r}
doacoes %>% 
  ggplot(mapping = aes(x = IDADE))+
  geom_histogram(binwidth = 1)+
  ylab("Quantidade")+
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=14,face="bold"))
```
<br />
<br />
#### Distribuição dos dados por idade e sexo
```{r}
doacoes %>%
  ggplot(mapping = aes(SEXO, IDADE, color=SEXO))+
  geom_boxplot()
```
<br />
<br />
#### Distribuição dos dados por idade e sexo
```{r}
doacoes %>% 
  ggplot(mapping = aes(x = IDADE))+
  geom_histogram(binwidth = 2)+
  ylab("Quantidade")+
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=14,face="bold"))+
  facet_wrap( ~ SEXO, ncol = 2)
```
<br />
<br />
#### Distribuição dos dados por idade e sexo na cidade de Porto Alegre
```{r}
doacoes %>% 
  subset(CIDADE == 'PORTO ALEGRE') %>%
  ggplot(mapping = aes(x = IDADE))+
  geom_histogram(binwidth = 2)+
  ylab("Quantidade")+
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=14,face="bold"))+
  facet_wrap( ~ SEXO, ncol = 2)
```
<br />
<br />
#### Distribuição dos dados por idade e sexo nas principais cidades exceto Porto Alegre
```{r}
doacoes[ doacoes$CIDADE %in%  names(table(doacoes$CIDADE))[table(doacoes$CIDADE) > 250] , ] %>% 
  subset(CIDADE != 'PORTO ALEGRE') %>%
  ggplot(mapping = aes(x = IDADE))+
  geom_histogram(binwidth = 1)+
  ylab("Quantidade")+
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=14,face="bold"))+
  facet_wrap( ~CIDADE, ncol = 2)
```






