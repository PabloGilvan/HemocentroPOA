---
title: "Hemocentro"
output:
  pdf_document: default
  html_notebook: default
---

Análise da base de dados do hemocentro de Porto Alegre
Fontes:
https://www.fee.rs.gov.br/indicadores/populacao/estimativas-populacionais/


#### Carregando bibliotecas
```{r}
library(tidyverse)
library(gridExtra)
library(readr)
library(stringr)
library(reshape2)
library(stringi)

#Setando Encoding
Sys.setlocale("LC_ALL", "pt_BR.UTF-8")
```

#### Carregando dados
```{r}
doacoes <- read.csv2(file = 'doacao-Table 1.csv')
transfusoes <- read.csv2(file = 'transfusao-Table 1.csv')
```

#### Listando uma amostra dos dados para ver se está tudo ok.
```{r}
head(doacoes)
```

```{r}
head(transfusoes)
```

Todas as duas tabelas parecem ter uma coluna ID fora do contexto. Vamos removelas. 
```{r}
doacoes <- subset(doacoes, select = -c(ID) )
transfusoes <- subset(transfusoes, select = -c(ID) )
```


Carregando os dados para validar novamente.
```{r}
head(doacoes)
```

```{r}
head(transfusoes)
```

#### Vamos começar analisando os dados que temos em mãos, antes de tentar qualquer associaão com o outro dataframe.

## Doações

### Doações por cidade

#### Sumário dos dados
```{r}
summary(doacoes)
```

#### Valores de cidades
```{r}
cidades <- table(doacoes$CIDADE)
head(cidades)
```

#### Quantidade de cidades
```{r}
length(cidades)
```

Agora vamos pegar esse agrupamento de Cidade/Doacoes que está em formato Table e transformar para um Dataframe, para conseguir melhor trabalhar com os dados.
```{r}
cidades <- as.data.frame(cidades)
colnames(cidades) <- c("Cidade", "Doacoes")
head(cidades)
```

#### Ordenando as 10 principais cidades com mais doadores
```{r}
order.donnations <- with(cidades, order(-Doacoes))
first_ten <- head(cidades[order.donnations,],  10)
first_ten
```

Ok, temos bastante registros para plotar e não teríamos como exibir toda essa quantidade de valores únicos em um gráfico, não de forma que ficasse de fácil visualização.
Vamos começar listando as 10 cidades com maior quantidade de doadores.
```{r}
first_ten %>% 
  ggplot(mapping = aes(x = Cidade, y = Doacoes))+
  geom_col() +
  ylab("Quantidade de doações")+
  theme(axis.text=element_text(size=8),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))

```

Bom, as 10 primeira cidades, especiamente a primeira, estrapolam nossa chance de printar um gráfico de forma que fique 
apresentável. 

#### Comparando o percentual de doações baseando-se na quantidade de habitantes.

Vamos começar carregando o indicador populacional por cidades do estado do RS.

```{r}
pop_cidades <- read.csv2(file = '20170831populacao-municipio-sexo-fx-2016.csv', sep = ";")
head(pop_cidades)
```

Bom, os nomes das cidades estão em formato normal quando que os do nosso dataset de doações estão todos em caixa alta.
Vamos ter que trabalhar os dos dois, pois parece que alguns dos registros do dataset de doações não estão em caixa alta.

```{r}
pop_cidades$MUNICIPIO <- str_to_upper(pop_cidades$MUNICIPIO)
doacoes$CIDADE <- str_to_upper(doacoes$CIDADE)

head(pop_cidades)
```

Quase pronto, antes precisamos ter as tabelas com o mesmo nome para a coluna Municipio, hoje no dataset de doações
estão com nome de 'CIDADE' e no de pop_cidades está como 'MUNICIPIO'.
Para padronizar, vamos renomear a tabela pop_cidade, até pelo fato do dataset estar com 'cidade' no nome.

```{r}
colnames(pop_cidades)[2]  <- "CIDADE"
head(pop_cidades)
```

Também nos deparamos com outra situação, parece que alguns valores na tabela de doações estão com acentuação e outros não.
```{r}
aux <- doacoes %>%
  filter(str_detect(CIDADE,"SÃO"))

print(aux$CIDADE[1:2])

aux <- doacoes %>%
  filter(str_detect(CIDADE,"SAO"))

print(aux$CIDADE[1:2])

#Removendo acentua????o.
doacoes$CIDADE <- stri_trans_general(doacoes$CIDADE,"Latin-ASCII")

print("VALORES COM ACENTUAÇÃO")
doacoes %>%
  filter(str_detect(CIDADE,"SÃO")) %>%
  print()

print("VALORES SEM ACENTUAÇÃO")
doacoes %>%
  filter(str_detect(CIDADE,"SAO")) %>%
  head() %>%
  print()

pop_cidades$CIDADE <- stri_trans_general(pop_cidades$CIDADE,"Latin-ASCII")

pop_cidades %>%
  filter(str_detect(CIDADE,"GRAV")) %>%
  head() %>%
  print()

```

Perfeito, agora podemos unir a tabela de municípios com a tabela de doações.

```{r}
doacoes <- doacoes %>%
  left_join(pop_cidades, by = "CIDADE") 

head(doacoes)
```

Agora vamos calcular a proporção de doações em relação a população da cidade.
Vamos começar com uma análise mais ampla, vamos agrupar por cidade e depois por cidade e sexo.

#### Agrupamento por CIDADE
```{r}
doacoes$CIDADE <- factor(doacoes$CIDADE)

group_cidade <- group_by(doacoes, CIDADE, TOTAL, TOTAL_H, TOTAL_M)%>%
  summarise(DOACOES=n()) %>%
  arrange(-DOACOES)

group_cidade$PROPORCAO <- group_cidade$DOACOES/group_cidade$TOTAL

group_cidade <- group_cidade %>% 
  arrange(-PROPORCAO)

```

#### As cidades com maior proporção de doações por habitantes
```{r}
group_cidade %>% 
  head(n = 10) %>%
  ggplot(mapping = aes(x = CIDADE, y = PROPORCAO))+
  geom_bar(stat = "identity")+
  ylab("Proporção")+
  coord_flip()+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))
```


#### Agrupamento por CIDADE e SEXO
Para agrupamento por cidade, vamos fazer diferente, vamos dividir nosso dataset em dois, pois temos os casos de mulheres e homens, provavelmente
a proporção de doação será diferente em uma mesma cidade para homens e para mulheres.
```{r}

# Começamos agrupando o nosso dataset por sexo.
group_cidade_sexo <- group_by(doacoes, CIDADE, TOTAL, TOTAL_H, TOTAL_M, SEXO)%>%
  summarise(DOACOES=n())

group_cidade_sexo$PROPORCAO <- group_cidade_sexo$DOACOES/group_cidade_sexo$TOTAL

#Ok, agora precisamos separar mulheres e homens já aproveitando para remover dados incompletos.
group_cidade_homens <- subset(group_cidade_sexo, SEXO == 'M')
group_cidade_homens <- group_cidade_homens[complete.cases(group_cidade_homens[,1:7]),]

group_cidade_mulheres <- subset(group_cidade_sexo, SEXO == 'F')
group_cidade_mulheres <- group_cidade_mulheres[complete.cases(group_cidade_mulheres[,1:7]),]

#Agora vamos filtrar somente as 10 cidades com maiores proporções de doação para cada sexo.
group_cidade_homens <- group_cidade_homens %>%
  arrange(-PROPORCAO) %>%
  head(n=10)

group_cidade_mulheres <- group_cidade_mulheres %>%
  arrange(-PROPORCAO) %>%
  head(n=10)

#Pronto, agora vamos agrupar novamente os dados para então plotarmos esses valores.
group_cidade_sexo <- union(group_cidade_homens, group_cidade_mulheres)

head(group_cidade_sexo)
```

#### As cidades com maior proporção de doações por habitantes separados por sexo
```{r}

plot_m <- group_cidade_sexo %>%
  subset(SEXO == 'M') %>%
  ggplot(mapping = aes(x = CIDADE, y = PROPORCAO))+
  geom_bar(stat = "identity")+
  ylab("Masculino")+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))

plot_f <- group_cidade_sexo %>%
  subset(SEXO == 'F') %>%
  ggplot(mapping = aes(x = CIDADE, y = PROPORCAO))+
  geom_bar(stat = "identity")+
  ylab("Feminino")+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))


grid.arrange(plot_m, plot_f, ncol = 2)
```


#### Exibindo proporção de doações para cada gênero em todas as 10 cidades com maior proporção para cada gênero
```{r}
group_cidade_sexo %>%
  subset(CIDADE %in% group_cidade_sexo$CIDADE) %>%
  ggplot(mapping = aes(x = CIDADE, y = PROPORCAO, color= SEXO, fill=SEXO))+
  geom_bar(stat = "identity")+
  ylab("Proporção")+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))  
```

### Tipos de doações
Vamos analisar os tipos de doações e a quantidade de cada tipo. Vamos começar focando nas cidades onde as mulheres tiveram 100% das doações e onde os homens foram responsáveis por 100% delas.

#### Tipo de doações onde homens tiveram 100% de doações

```{r}
nomes <- c("CAPAO BONITO DO SUL", "MORRO REUTER", "PARAI", "SENTINELA DO SUL")

doacoes %>%
  filter(CIDADE %in% nomes) %>%
  ggplot(mapping = aes(x = TIPO))+
  geom_bar()+
  labs(title="Cidades com doacoes 100% de homens")+
  ylab("Quantidade")+
  xlab("Tipo")+
  theme(axis.text=element_text(size=8),
        plot.title = element_text(color="red", size=12, face="bold.italic"),
        axis.title=element_text(size=14,face="bold")) 
```



#### Analisando as doações da cidade de Porto Alegre
```{r}
poa_df <- subset(doacoes, doacoes$CIDADE == 'PORTO ALEGRE')

print('Sumário por bairros.')
summary(poa_df$BAIRRO)
```
Ok, temos vários resultados, não seria nada interessante colocar todos esses valores em um gráfico.
Vamos limitar somente nos bairros com mais de 100 doadores.

#### Filtrando bairros
```{r}
poa_bairros_df <- poa_df[ poa_df$BAIRRO %in%  names(table(poa_df$BAIRRO))[table(poa_df$BAIRRO) > 100] , ]

poa_bairros_df %>% 
  ggplot(mapping = aes(x = BAIRRO))+
  geom_bar() +
  ylab("Número de Doadores")+
  theme(axis.text=element_text(size=7),
        axis.text.x = element_text(angle = 90, hjust = 1),
        axis.title=element_text(size=14,face="bold"))
```


#### Criando função para calcular a idade dos doadores
```{r}
calc_idade <- function(data_str) {
  data_nasc <- as.Date(as.character(data_str), format="%Y-%m-%d %H:%M:%S")
  years <- as.numeric(difftime(Sys.Date(), data_nasc, unit="weeks"))/52.25
  return(as.numeric(round(years)))
}
```

#### Aplicando função no DF
```{r}
doacoes$IDADE <- sapply(doacoes$NASCIMENTO, calc_idade)
summary(doacoes$IDADE)
```


#### Distribuição dos dados por idade
```{r}
doacoes %>% 
  ggplot(mapping = aes(x = IDADE))+
  geom_histogram(binwidth = 1)+
  ylab("Quantidade")+
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=14,face="bold"))
```

#### Distribuição dos dados por idade e sexo
```{r}
ggplot(data = doacoes, mapping = aes(x = SEXO, y = IDADE, group = 1))+
  stat_summary(fun.ymin = min, fun.ymax = max, fun.y = median)+
  geom_line(stat = 'summary', fun.y = mean)+
  geom_line(stat = 'summary', fun.y = quantile, fun.args = list(probs = .1),
            linetype = 2, color =  'blue')+
  geom_line(stat = 'summary', fun.y = quantile, fun.args = list(probs = .75),
            linetype = 3, color =  'red')+
  geom_line(stat = 'summary', fun.y = quantile, fun.args = list(probs = .9),
            linetype = 2, color =  'blue')+
  geom_line(stat = 'summary', fun.y = quantile, fun.args = list(probs = .25),
            linetype = 3, color =  'red')
```


#### Distribuição dos dados por idade e sexo
```{r}
doacoes %>% 
  ggplot(mapping = aes(x = IDADE))+
  geom_histogram(binwidth = 1)+
  ylab("Quantidade")+
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=14,face="bold"))+
  facet_wrap( ~ SEXO, ncol = 2)
```


#### Distribuição dos dados por idade e sexo na cidade de Porto Alegre
```{r}
doacoes %>% 
  subset(CIDADE == 'PORTO ALEGRE') %>%
  ggplot(mapping = aes(x = IDADE))+
  geom_histogram(binwidth = 1)+
  ylab("Quantidade")+
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=14,face="bold"))+
  facet_wrap( ~ SEXO, ncol = 2)
```

#### Distribuição dos dados por idade e sexo nas principais cidades exceto Porto Alegre
```{r}
doacoes[ doacoes$CIDADE %in%  names(table(doacoes$CIDADE))[table(doacoes$CIDADE) > 250] , ] %>% 
  subset(CIDADE != 'PORTO ALEGRE') %>%
  ggplot(mapping = aes(x = IDADE))+
  geom_histogram(binwidth = 1)+
  ylab("Quantidade")+
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=14,face="bold"))+
  facet_wrap( ~CIDADE, ncol = 2)
```






